import { HTMLClip, loadPlugin, Effect } from '../../main';
import { easing } from '../easings';

/** ************************* PLUGIN DEFINITION ************************ */
/** ******************************************************************* */
class MyPluginIncident extends Effect {
  onGetContext() {}

  onProgress(ms) {
    const fraction = this.getFraction(ms);
    // eslint-disable-line no-unused-vars
    const { initialValue } = this;
    const { targetValue } = this;
    const value = initialValue + (targetValue - initialValue) * fraction;

    this.element.setAttribute(this.attributeKey, value);
  }

  getScratchValue() {
    // eslint-disable-line no-unused-vars
    return 0;
  }
}

class MyPluginClip extends HTMLClip {
  buildTree() {}

  get html() {
    return `
            <div>
                <div class="sub-class" id="my-test-div" data-motorcortex2-id="my-subclass-1"></div>
                <div class="sub-class" id="my-test-div-2" data-motorcortex2-id="my-subclass-2"></div>
            <div>`;
  }

  get css() {
    return '';
  }
}

/** ************************* PLUGIN LOADING ************************** */
/** ******************************************************************* */
const testPlugin = {
  npm_name: '@donkeyclip/test-plugin',
  name: 'Test Plugin',
  incidents: [
    {
      exportable: MyPluginIncident,
      name: 'MPInc',
    },
    {
      exportable: MyPluginClip,
      name: 'MPClip',
    },
  ],
};

const TestPlugin = loadPlugin(testPlugin);

test('EAS.1 test that preset easing operates as expected on Incidents', () => {
  /** ********************* ROOT CLIP DEFINITION ************************ */
  /** ******************************************************************* */
  document.body.innerHTML = '<div id="clip-container"></div>';

  const myClip = new HTMLClip({
    html: `
            <div id="my-root-div">
                <div id="element-1" class="my-class" data-motorcortex2-id="my-class-1" test="0"></div>
                <div id="element-2" class="my-class" data-motorcortex2-id="my-class-2" test="0"></div>
                <div id="element-3" class="class-1" data-motorcortex2-id="class-1"></div>
                <div id="element-3-1" class="class-1" data-motorcortex2-id="class-1-2"></div>
            </div>`,
    css: `
            #my-root-div {
                width: 800px;
                height: 400px;
            }
            .my-class {
                display: inline-block;
                width: 50%;
                height: 100%;
            }
        `,
    host: document.querySelector('#clip-container'),
    id: 'my-clip',
  });

  const newMPInc = new TestPlugin.MPInc(
    {
      animatedAttrs: {
        test: 1000,
      },
    },
    {
      selector: '.my-class',
      duration: 1000,
      easing: 'easeInCubic',
    },
  );

  myClip.addIncident(newMPInc, 0);

  /** *********************** ROOT CLIP PROGRESS ************************ */
  /** ******************************************************************* */
  myClip.playableProgress(500 / myClip.duration, 500);
  const expectedVal = easing.easeInCubic(0.5) * 1000;
  expect(
    parseInt(
      myClip.realClip.context
        .getElementByMCID('my-class-1')
        .getAttribute('test'),
    ),
  ).toBe(expectedVal);
  expect(
    parseInt(
      myClip.realClip.context
        .getElementByMCID('my-class-2')
        .getAttribute('test'),
    ),
  ).toBe(expectedVal);
});

test('EAS.2 test that custom easing operates as expected on Incidents', () => {
  /** ********************* ROOT CLIP DEFINITION ************************ */
  /** ******************************************************************* */
  document.body.innerHTML = '<div id="clip-container"></div>';

  const myClip = new HTMLClip({
    html: `
            <div id="my-root-div">
                <div id="element-1" class="my-class" data-motorcortex2-id="my-class-1" test="0"></div>
                <div id="element-2" class="my-class" data-motorcortex2-id="my-class-2" test="0"></div>
                <div id="element-3" class="class-1" data-motorcortex2-id="class-1"></div>
                <div id="element-3-1" class="class-1" data-motorcortex2-id="class-1-2"></div>
            </div>`,
    css: `
            #my-root-div {
                width: 800px;
                height: 400px;
            }
            .my-class {
                display: inline-block;
                width: 50%;
                height: 100%;
            }
        `,
    host: document.querySelector('#clip-container'),
    id: 'my-clip',
  });

  const newMPInc = new TestPlugin.MPInc(
    {
      animatedAttrs: {
        test: 1000,
      },
    },
    {
      selector: '.my-class',
      duration: 1000,
      easing: [0, 0, 1, 1], // linear
    },
  );

  myClip.addIncident(newMPInc, 0);

  /** *********************** ROOT CLIP PROGRESS ************************ */
  /** ******************************************************************* */
  myClip.playableProgress(500 / myClip.duration, 500);
  const expectedVal = easing.linear(0.5) * 1000;
  expect(
    parseInt(
      myClip.realClip.context
        .getElementByMCID('my-class-1')
        .getAttribute('test'),
    ),
  ).toBe(expectedVal);
  expect(
    parseInt(
      myClip.realClip.context
        .getElementByMCID('my-class-2')
        .getAttribute('test'),
    ),
  ).toBe(expectedVal);
});
