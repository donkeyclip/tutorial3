/*
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */

import MediaPlayIncident from '../../../RealIncidents/MediaPlayIncident';
import { audioContext, hasOwnProp } from '../../../_coreUtils/helper';

/**
 * expects on its props:
 * - selector
 * - duration
 * - startFrom (optional)
 * */
class AudioPlayback extends MediaPlayIncident {
  play(millisecond) {
    if (!this.element.soundLoaded) {
      this.setBlock('loading sound');
      this.element.pubSub.sub(this.id, () => {
        this.unblock();
      });
      return false;
    }
    let startFrom = 0;
    if (hasOwnProp(this.props, 'startFrom')) {
      startFrom = this.props.startFrom;
    }
    // TODO the audioNode can be created on the _setBuffer method of AudioContextHandler once and stored on the element's
    // object so we don't need to recreate it every time here
    this.audioNode = audioContext.createBufferSource();
    this.audioNode.buffer = this.element.buffer;
    this.audioNode.connect(this.element.audioNodeSet.input);

    this.audioNode.start(0, (millisecond + startFrom) / 1000);
    return true;
  }

  stop() {
    if (this.audioNode) this.audioNode.stop();
  }
}

export default AudioPlayback;
